<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="initial-scale=1.0,user-scalable=yes">
<meta name="description" content="Demo to add a number on each stroke of
a Japanese or Chinese character using animCJK svg files">
<link rel="stylesheet" href="_css/withSelector.css" type="text/css">
<style>
#a
{
	width:300px;
	height:300px;
	border:1px solid #ccc;
	margin-top:0.5em;
}
#a svg
{
	display:block;
}
</style>
<title>AnimCJK Numbers</title>
</head>
<body>
<h1>AnimCJK Numbers</h1>
<nav class="link">
<a href="https://github.com/parsimonhi/animCJK"><span>Download</span></a>
<a href="./"><span>Sample selector</span></a>
</nav>
<div class="langSelector"></div>
<div class="charSelector"></div>
<label>Add numbers: <input type="checkbox" name="numbers"></label>
<div id="a"></div>
<pre class="codeTag"></pre>
<div class="charListSelector"></div>
<footer>
<nav class="link">
<a href="#"><span>Top</span></a>
<a href="./"><span>Sample selector</span></a>
<a href="../licenses/COPYING.txt"><span>Licences</span></a>
</nav>
</footer>
<script src="_js/magicAcjk.js"></script>
<script>
function updateCodeTag()
{
	let e,s;
	e=document.getElementById("a");
	s=e.innerHTML;
	s=s.replace(/((<\/circle>)|(<\/text>))/g,"$1\n");
	s=s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
	document.querySelector('.codeTag').innerHTML=s;
}
function getRadioValue(name)
{
	let list=document.querySelectorAll('[name="'+name+'"]');
	for(k=0;k<list.length;k++) if(list[k].checked) return list[k].value;
	return "Ja";
}
function setNumbers(x)
{
	// this function adds/removes stroke numbers
	let go,g,list,k,km,l,a,c,e,cx,cy,cx1,cy1,cx2,cy2,d,sx,sy,fs=40,list0,km0;
	if (x)
	{
		// add numbers
		list0=document.querySelectorAll("svg.acjk path[id]");
		km0=list0.length;
		list=document.querySelectorAll("svg.acjk path:not([id])");
		km=list.length;
		l=0;
		go=0;
		for (k=0;k<km;k++)
		{
			// since several character svg can be in the page,
			// do not set g outside the loop
			g=list[k];
			while (g.tagName!="svg") g=g.parentNode;
			if (g!=go) {l=0;go=g;}
			// safer to test id of list0 than clip-path url of list for normal browsers
			// clip-path attributes were removed for pitiful browsers
			// so use list0 id to get the number of the path
			if (list0[k].getAttributeNS(null,'id').match(/d[0-9]+a?$/))
			{
				l++;
				if (list[k].hasAttributeNS(null,"data-median"))
					a=list[k].getAttributeNS(null,"data-median");
				else a=list[k].getAttributeNS(null,"d");
				a=a.replace(/([0-9])[-]/g,"$1 -");
				c=a.match(/M[ ]*([0-9.-]+)[ ,]+([0-9.-]+)[^0-9.-]+([0-9.-]+)[ ,]+([0-9.-]+)/);
				if (c&&c.length)
				{
					cx1=parseInt(c[1]);
					cy1=parseInt(c[2]);
					cx2=parseInt(c[3]);
					cy2=parseInt(c[4]);
					d=Math.sqrt((cy2-cy1)*(cy2-cy1)+(cx2-cx1)*(cx2-cx1));
					if (d)
					{
						cx=cx1+(cx2-cx1)*fs/d/2;
						cy=cy1+(cy2-cy1)*fs/d/2;
					}
					else
					{
						cx=cx1;
						cy=cy1;
					}
					if (cx<(fs+(fs>>3))) cx=fs+(fs>>3);
					if (cy<(fs+(fs>>3))) cy=fs+(fs>>3);
					sx=((k+1)>=10)?0.875:1;
					sy=-1;
					e=document.createElementNS('http://www.w3.org/2000/svg','circle');
					e.setAttributeNS(null,"cx",cx);
					e.setAttributeNS(null,"cy",cy);
					e.setAttributeNS(null,"r",fs);
					e.setAttributeNS(null,"stroke","#000");
					e.setAttributeNS(null,"fill","#fff");
					e.setAttributeNS(null,"stroke-width",Math.max(1,fs>>3));
					g.appendChild(e);
					e=document.createElementNS('http://www.w3.org/2000/svg','text');
					e.setAttributeNS(null,"x",cx);
					e.setAttributeNS(null,"y",cy+(fs>>1));
					e.setAttributeNS(null,"text-anchor","middle");
					e.setAttributeNS(null,"font-family","arial");
					e.setAttributeNS(null,"font-weight","normal");
					e.setAttributeNS(null,"fill","#000");
					e.setAttributeNS(null,"font-size",(fs>>1)*3);
					e.textContent=l;
					g.appendChild(e);
				}
			}
		}
	}
	else
	{
		// remove numbers
		list=document.querySelectorAll("svg.acjk circle, svg.acjk text");
		km=list.length;
		if (km) 
			for (k=0;k<km;k++)
			{
				g=list[k].parentNode; // must set g here
				g.removeChild(list[k]);
			}
	}
}
function switchNumbers()
{
	setNumbers(document.querySelector('[name="numbers"]').checked);
	updateCodeTag();
}
function updateInfo(s)
{
	let d=new Date().getFullYear();
	s=s.replace(/AnimCJK [0-9-]+/,"AnimCJK 2016-"+d);
	s=s.replace(/Copyright[^-]+-/,"Copyright FM&SH -");
	return s;
}
function run(s)
{
	s=updateInfo(s);
	s=s.replace(/<style[^Â£]+\/style>\s/,"");
	document.getElementById("a").innerHTML=s;
	switchNumbers(); 
}
function doIt()
{
  	let e=document.querySelector('[name="char"]'),c=e.value;
  	document.getElementById("a").innerHTML="";
  	document.querySelector('.codeTag').innerHTML="";
	if(c)
	{
		let dec=c.codePointAt(0),lang=getRadioValue("lang");
		e.value=String.fromCodePoint(dec);
		fetch('../svgs'+lang+'/'+dec+'.svg')
		.then(r=>{if(!r.ok) throw r.statusText; return r.text();})
		.then(r=>{run(r);return true;})
		.catch(e=>document.getElementById("a").innerHTML=e+' in svgs'+lang);
	}
}
window.addEventListener("load",function(){
	let e=document.querySelector('[name="numbers"]');
	e.checked=true;
	e.addEventListener("click",switchNumbers);
});
</script>
<script src="_js/selectorAcjk.js"></script>
</body>
</html>